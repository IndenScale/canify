# Canify 验证策略

## 1. 概述

Canify 的核心是其**统一验证引擎** (`ValidationEngine`) 支持的**分层验证策略**。该策略旨在将软件工程的质量保证思想无缝融入到“文档即代码”的工作流中。通过在不同开发阶段设立三级“质量门” (`Quality Gates`)，它在开发效率和知识库质量之间取得了最佳平衡。

## 2. 三级质量门：一个引擎，三种模式

Canify 提供三个核心命令，它们本质上是调用**同一个验证引擎**的不同“预设模式”，分别对应开发工作流中的三个关键阶段。

| 命令              | 开发阶段          | 核心目标                                           | 建议触发方式               |
| :---------------- | :---------------- | :------------------------------------------------- | :------------------------- |
| `canify lint`     | **编辑 (Edit)**   | 提供关于格式和基本语法的即时反馈。                 | 编辑器保存时 (On-Save)     |
| `canify verify`   | **提交 (Commit)** | 保证提交入库的知识图谱在结构和形式上是完整的。     | Git `pre-commit` 钩子      |
| `canify validate` | **合并 (Merge)**  | 确保合入主干的知识在业务逻辑和语义上是完全正确的。 | CI/CD 流水线 (On-PR/Merge) |

## 3. 核心验证流程：验证引擎的四个阶段

`ValidationEngine` 的执行过程由四个连续的阶段组成，每个阶段的验证深度和严格性由 `mode` (`lint`, `verify`, `validate`) 和 `strict` 参数控制。

### 阶段一：符号发现 (Symbol Discovery)

- **目标**: 扫描所有 Markdown 文件，解析出全部的实体声明，构建符号表。
- **检查内容**:
  - ` ```entity ` 代码块内的 YAML 语法是否有效。
  - 实体声明是否包含 `type`, `id`, `name` 等必需的基本字段。
  - **重复的实体 ID**: 检查并报告在整个项目中重复的实体 ID。
- **执行阶段**: `lint`, `verify`, `validate` 都会执行此阶段。

### 阶段二：引用验证 (Reference Validation)

- **目标**: 解析所有的实体引用，并确保它们的有效性。
- **检查内容**:
  - `entity://` 引用链接的格式是否正确。
  - **悬空引用 (Dangling References)**: 检查实体引用是否指向一个不存在的 ID。
  - **循环依赖 (Circular Dependencies)**: 检查实体间的依赖关系是否存在闭环。
- **执行阶段**: `verify` 和 `validate` 会执行此阶段。`lint` 通常跳过此阶段以保证速度。

### 阶段三：Schema 验证 (Schema Validation)

- **目标**: 保证每个实体的数据都严格遵守其预期的类型和格式。
- **检查内容**:
  - **数据类型**: 字段值是否为正确的类型（如 `budget` 是数字）。
  - **值约束**: 字段值是否在预设的有效选项内（如 `status` 的值）。
  - **占位符处理**: 这是 `verify` 和 `validate` 的关键区别：
    - 在 `verify` 模式下，占位符 (如 "TBD", "TODO") 被识别并产生**警告 (Warning)**。
    - 在 `validate` 模式下，任何占位符都会被视为**错误 (Error)**。
- **执行阶段**: `verify` 和 `validate` 会执行此阶段。

### 阶段四：业务规则验证 (Business Rule Validation)

- **目标**: 执行用户定义的、跨实体的复杂业务逻辑。
- **检查内容**: 加载并执行 `constraints/` 目录中定义的规则。例如，检查“所有任务的总预算不能超过项目预算”。
- **严重性控制**: 规则的严重性（警告或错误）由 `spec_*.yaml` 文件根据当前的 `mode` (`verify` 或 `validate`) 来决定。
- **执行阶段**: `verify` 和 `validate` 会执行此阶段，但通常规则在 `verify` 模式下被配置为警告，在 `validate` 模式下配置为错误。

## 4. 验证策略总览矩阵

下表清晰地展示了三级质量门与验证引擎四个阶段的对应关系及行为差异：

| 验证阶段与检查项                   | `canify lint` (编辑时) | `canify verify` (提交时) | `canify validate` (合并时) |
| :--------------------------------- | :--------------------: | :----------------------: | :------------------------: |
| **1. 符号发现**                    |           ✅           |            ✅            |             ✅             |
| &nbsp;&nbsp;&nbsp; - 重复的实体 ID |           ✅           |            ✅            |             ✅             |
| **2. 引用验证**                    |           ❌           |            ✅            |             ✅             |
| &nbsp;&nbsp;&nbsp; - 悬空引用      |           ❌           |         **错误**         |          **错误**          |
| **3. Schema 验证**                 |           ❌           |            ✅            |             ✅             |
| &nbsp;&nbsp;&nbsp; - 占位符处理    |           ❌           |         **警告**         |          **错误**          |
| **4. 业务规则验证**                |           ❌           |     ✅ (通常为警告)      |      ✅ (通常为错误)       |
